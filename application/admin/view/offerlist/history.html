{extend name="index_layout"/}
{block name="main"}
<style type="text/css">
/*分页样式*/
.pagination{text-align:center;margin-top:20px;margin-bottom: 20px;}
.pagination li{margin:0px 10px; border:1px solid #e6e6e6;padding: 3px 8px;display: inline-block;}
.pagination .active{background-color: #dd1a20;color: #fff;}
.pagination .disabled{color:#aaa;}
.onfile {
    position: relative;
    display: inline-block;
    background: #D0EEFF;
    border: 1px solid #99D3F5;
    border-radius: 4px;
    padding: 4px 12px;
    overflow: hidden;
    color: #1E88C7;
    text-decoration: none;
    text-indent: 0;
    line-height: 20px;
}
.onfile input {
    position: absolute;
    font-size: 20px;
    right: 0;
    top: 0;
    opacity: 0;
}
.onfile:hover {
  opacity:0.8;
  color: #1E88C7
   /* background: #AADFFD;
    border-color: #78C3F3;
    color: #fff;
    text-decoration: none;*/
}
.daoru{position:absolute;top:1px;right:-90px;}
.daorus{position:absolute;top:1px;right:-50px;height:35px}
.bigbox{padding:10px}
.bigbox input{margin-bottom:10px}
#imgs{position:relative;}
.batchs span{cursor:pointer;}
.form-control{display: inline-block;padding: 5px;}
/*.text-limit{overflow: hidden;text-overflow: ellipsis;white-space: nowrap;max-width: 110px;}*/
    .text-center{text-align: center !important;}
    td{
        text-align: center;
        padding:5px 5px !important;
    }
    th{
        padding:5px 5px !important;
    }
.layui-card-body{
    line-height:normal;
}
.layui-table td, .layui-table th{
    line-height:normal;
}
p{
    color: #484646
}

/*td{
    padding: 3px !important;
    font-size: 12px !important;
}
th{
    padding: 3px !important;
    font-size: 12px !important;
}*/
</style>
  <!-- 导出完成 -->
<div class="layui-card">
    <div class="layui-card-body">
        <div class="">
            <blockquote class="layui-elem-quote news_search">
                <a style="float: right" href="{:url('admin/offerlist/history',['customerid'=>input('customerid'),'report_id'=>input('report_id'),'type'=>input('type')==2?'':2])}" class="layui-btn layui-btn-sm layui-btn-primary"><?php echo input('type')==2?'切换原单':'切换完整订单' ?></a>
                <form class="layui-inline">
                    <a class="layui-btn layui-btn-sm" id="export" href = "{:url('admin/offerlist/excel_export',['customerid'=>input('customerid'),'report_id'=>input('report_id'),'type'=>input('type')])}">导出报表</a>
                    <button class="layui-btn layui-btn-sm" type="button" data-fun="print" id="btn_export">打印</button>
                    <select class="form-control" id="changestatus" data-id="{$order_info.id}" data-customerid="{$order_info.customerid}">
                        <option>选择标签</option>
                        <option value="0">未报价</option>
                        <option value="1">已报价</option>
                        <option value="2">预算价</option>
                        <option value="3">合同价</option>
                        <option value="4">结算价</option>
                    </select>
                    {switch name="order_info.status"}
                        {case value="0"}<a class="layui-btn layui-btn-xs layui-btn-danger">未报价</a>{/case}
                        {case value="1"} <a class="layui-btn layui-btn-xs layui-btn-danger">已报价</a>{/case}
                        {case value="2"}<a class="layui-btn layui-btn-xs layui-btn-danger">预算价</a>{/case}
                        {case value="3"} <a class="layui-btn layui-btn-xs layui-btn-danger">合同价</a>{/case}
                        {case value="4"} <a class="layui-btn layui-btn-xs layui-btn-danger">结算价</a>{/case}
                        {default /}
                        <a class="layui-btn layui-btn-xs layui-btn-danger">未报价</a>
                    {/switch}
                </form>
            </blockquote>
            <div id="export-table">
                
                <p>
                   <img style="max-width:160px;" src="__STATIC__/imgs/logo.png">
                </p>
                <p style="text-align: center;font-weight: 900;font-size: 22px;margin-bottom:10px">
                    住宅装饰工程造价预算书
                </p>
                <p style="width: 98%;padding:0 1%;">
                    <span style="text-align: left">工程名称：{$userinfo.address}</span>
                    <span style="float: right"><?php echo date('Y-m-d'); ?></span>
                </p>
                
                {notempty name="datas"}
                <!-- <table class="layui-table" style="word-break:break-all"> -->
                <table class="layui-table" style="margin-top: 0px">
                    <colgroup>
                        <col width="30">
                        <col width="50">
                        <col width="30">
                        <col width="30">
                        <col width="30">
                        <col width="30">
                        <col width="30">
                        <col width="30">
                        <col width="250">
                      </colgroup>
                    <thead>
                        
                    </thead>
                    <tbody> 
                        
                        <tr>
                            <th style="text-align:center;" colspan="9">公司名称：{$order_info.unit}</th>                
                        </tr>
                        <tr>
                            <th style="text-align:center;" colspan="9">
                                <span style="width: 30% ;display: inline-block;text-align:left;height: 20px">客户：{$userinfo.customer_name}</span>
                                <span style="width: 30% ;display: inline-block;text-align:center;height: 20px">设计师：{$userinfo.designer_name}</span>
                                <span style="width: 30% ;display: inline-block;text-align:right;height: 20px">报价师：{$userinfo.quoter_name}</span>
                            </th>        
                        </tr>
                        <tr>      
                            <th class="text-center" rowspan="2" colspan="1">序号</th>
                            <th class="text-center" rowspan="2">工程项目名称</th>         
                            <th class="text-center" rowspan="2">数量</th>       
                            <th class="text-center" rowspan="2">单位</th>
                            <th class="text-center" colspan="2">辅材费</th> 
                            <th class="text-center" colspan="2">人工费</th>    
                            <th class="text-center" rowspan="2">施工工艺及材料说明</th> 
                        </tr>
                        <tr>   
                            <th class="text-center" colspan="1">单价</th>       
                            <th class="text-center">合计</th>       
                            <th class="text-center">单价</th>       
                            <th class="text-center">合计</th> 
                        </tr>
                        {notempty name="datas"}
                            <?php 
                                $num1 = 1;
                                $total_quota = 0;
                                $total_craft_show = 0;
                                $num2=65; 
                            ?>
                            {foreach name="datas" item="v1" key="k1"}
                                <tr id="tr{$k1}">
                                        <td><?php echo chr($num2); ?></td>
                                        <td style="text-align: left; padding-left: 25px!important" colspan="9">{$k1}</td>
                                    </tr>
                                <?php
                                        $num2++; 
                                        $space_total1=0;//辅材
                                        $space_total2=0; //人工
                                ?>
                                {foreach name="$v1" key="k2" item="v2"}
                                    <tr class="">
                                            <td>{$num1}</td>
                                            <td style="text-align: left;">{$offerquota[$k2]['project']}</td>
                                            <td>{$v2.num}</td>
                                            <td>{$offerquota[$k2]['company']}</td>
                                            <td>{$offerquota[$k2]['quota']}</td>
                                            <td>{$v2.num?$v2.num*$offerquota[$k2]['quota']:0}</td>
                                            <td>{$offerquota[$k2]['craft_show']}</td>
                                            <td>{$v2.num?$v2.num*$offerquota[$k2]['craft_show']:0}</td>
                                            <td>{$offerquota[$k2]['material']}</td>
                                            <input type="hidden" form="myform" name="" value="">
                                        </tr>
                                        <?php 
                                            $total_quota += $v2['num']?$v2['num']*$offerquota[$k2]['quota']:0;
                                            $total_craft_show += $v2['num']?$v2['num']*$offerquota[$k2]['craft_show']:0;
                                            $space_total1 += $v2['num']?$v2['num']*$offerquota[$k2]['quota']:0;
                                            $space_total2 += $v2['num']?$v2['num']*$offerquota[$k2]['craft_show']:0;
                                            $num1++;
                                         ?>
                                {/foreach}
                                <tr class="">
                                    <td class="text-center"  colspan="2">小计</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td>{$space_total1}</td>
                                    <td></td>
                                    <td>{$space_total2}</td>
                                    <td></td>
                                </tr>
                            {/foreach}
                            <tr>
                                <td class="text-center" colspan="2">直接费</td>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>{$total_quota}</td>
                                <td></td>
                                <td>{$total_craft_show}</td>
                                <td></td>
                            </tr>
                            <?php $num=97; ?>
                            {notempty name="offerlist_info['order_cost']"}
                                {foreach name="$offerlist_info['order_cost']" item="vcost" key="kcost"}
                                    <tr>
                                        <td class="text-center" colspan="2">{$vcost.name}</td>
                                        <td colspan="6">{$vcost.price}</td>
                                        <td></td>
                                    </tr>
                                    <?php $num++; ?>
                                {/foreach}
                            {/notempty}
                            {notempty name="offerlist_info['discount']"}
                                <tr>
                                    <td class="text-center" colspan="2">优惠</td>
                                    <td colspan="6">{$offerlist_info['discount']}</td>
                                    <td></td>
                                    <?php $num++; ?>
                                </tr>
                            {/notempty}
                            <tr>
                                <td class="text-center" colspan="2">工程报价</td>
                                <td colspan="6">{$offerlist_info.discount_proquant}</td>
                                <td></td>
                            </tr>
                            {notempty name="cost_tmp['order_tfoot']"}
                                <?php foreach(explode("\n",$cost_tmp['order_tfoot']) as $k=>$v){ ?>
                                    <tr>
                                        <td colspan="9" style="text-align: left">{$v}</td>
                                    </tr>
                                <?php } ?>
                            {/notempty}
                        {/notempty}
                    </tbody>
                    <tfoot>
                    </tfoot>
                </table>
                <div style="padding: 20px;color: #484646">
                    <span style="width: 24% ;display: inline-block;text-align:left;">业主：</span>
                    <span style="width: 24% ;display: inline-block;text-align:left;">设计师：</span>
                    <span style="width: 24% ;display: inline-block;text-align:left;">商务经理：</span>
                    <span style="width: 24% ;display: inline-block;text-align:left;">报价师：</span>
                </div>
                {/notempty}
            </div>
        </div>
    </div>
</div>
{/block}

{block name="script"}
<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- 打印 -->
<script src="__STATIC__/bootstrap/js/table/printThis.min.js"></script>
<script>
  $(document).ready(function(){
    $('tr').each(function(){
        var cate = $(this).attr('data-cate');
        if(cate){
          var fd_total = 0,rd_total = 0;
             $('tr[class*='+cate+']').each(function(){
                var fd = $(this).find('td').eq(5).html() * 1;//辅材合价
                var rd = $(this).find('td').eq(7).html() * 1;//人工合价
               fd_total += fd;
               rd_total += rd;
             });
          $('.'+cate+'total').find('td').eq(4).html(Math.round(fd_total * 100)/100);
          $('.'+cate+'total').find('td').eq(6).html(Math.round(rd_total * 100)/100);
         }
    });

    // $('name["printIframe"]').load(function(){
    //     alert(1);
    // })
    
     //打印
     $(document).on('click','[data-fun="print"]',function(){
        
          $("#export-table").printThis({
             debug: false,
             importCSS: true,
             importStyle: true,
             printContainer: true,
             loadCSS: "__STATIC__/bootstrap/css/printThis-p.css",
             // pageTitle: '　',
             removeInline: false,
             printDelay: 333,
             header: null,
             formValues: false
           });
      })
        //改变报表标签
    $(document).on('change','#changestatus',function(){
      var id= $(this).attr('data-id'),customerid = $(this).attr('data-customerid'),status = $(this).val();
      // mystatus(id,customerid);
      $.ajax({
          type : 'post',
          url  :  '{:url("offerlist/status")}',
          dataType : 'json',
          data : {id:id,customerid:customerid,status:status},
          success : function(re){
            if(re.code == 0){
                alert(re.msg);
            }else{
                alert(re.msg);
                window.location.reload();
            }
          }
        });
    });
    
  });
</script>
{/block}

      
